#!/bin/bash
APP_PATH="/Applications/Claude Code Easy Suite.app"
APP_URL="file:///Applications/Claude%20Code%20Easy%20Suite.app/"
CURRENT_USER=$(stat -f '%Su' /dev/console)
RANDOM_GUID=$(od -An -N4 -t u4 /dev/urandom | tr -d ' ')

# 1. Force register app with LaunchServices
/System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f "$APP_PATH"

if [ -d "$APP_PATH" ]; then
    # Check if already in dock (check by app name)
    if ! sudo -u "$CURRENT_USER" defaults read com.apple.dock persistent-apps | grep -q "Claude%20Code%20Easy%20Suite.app"; then
        logger "CCEASY: Adding $APP_URL to Dock for user $CURRENT_USER with GUID $RANDOM_GUID"
        
        # Use a more complete XML structure matching system style
        DOCK_ITEM="<dict>
            <key>GUID</key><integer>$RANDOM_GUID</integer>
            <key>tile-data</key><dict>
                <key>file-data</key><dict>
                    <key>_CFURLString</key><string>$APP_URL</string>
                    <key>_CFURLStringType</key><integer>15</integer>
                </dict>
                <key>file-label</key><string>Claude Code Easy Suite</string>
                <key>file-type</key><integer>41</integer>
            </dict>
            <key>tile-type</key><string>file-tile</string>
        </dict>"
        
        sudo -u "$CURRENT_USER" defaults write com.apple.dock persistent-apps -array-add "$DOCK_ITEM"
        sudo -u "$CURRENT_USER" killall Dock
    fi
fi
exit 0
